#!/usr/bin/env oksh

. /etc/pragnastic/pragnastic.conf
. /etc/pragnastic/pragnastic.subr

usage() {
    echo "usage: `basename $0` log|volumes" >&2
    echo "usage: `basename $0` snapshot snapshot_id [primary|secondary]" >&2
    echo "usage: `basename $0` snapshots [primary|secondary]" >&2
}

if [[ "$1" != "log" && "$1" != "snapshots" && "$1" != "snapshot" && "$1" != "volumes" ]]; then
    usage
    exit 1
fi

# Show log
if [ "$1" == "log" ]; then
    echo "showing last 100 lines of /var/log/pragnastic:"
    tail -n 100 /var/log/pragnastic
fi

# List snapshots
if [ "$1" == "snapshots" ]; then
    # TODO: fix code duplication
    if [[ "$2" == "primary" || "$2" == "" ]]; then            
        if exists $primary_backup_repo; then
            echo "showing snapshots of primary backup repository at $primary_backup_repo"
            restic --repo $primary_backup_repo --password-file $backup_repo_passwdfile snapshots
        else
            echo "[ERROR] primary backup at $primary_backup_repo unavailable" >&2
        fi
    elif [ "$2" == "secondary" ]; then
        if exists $secondary_backup_repo; then
            echo "showing snapshots of secondary backup repository at $secondary_backup_repo"
            restic --repo $secondary_backup_repo --password-file $backup_repo_passwdfile snapshots
        else
            echo "[ERROR] secondary backup at $secondary_backup_repo unavailable" >&2
        fi
    else
        usage
        exit 1
    fi
fi

# Show snapshot content
if [ "$1" == "snapshot" ]; then
    if [ "$2" != "" ]; then
        restic --repo $primary_backup_repo --password-file $backup_repo_passwdfile ls $2
    else
        usage
        exit 1
    fi
fi

# Show volumes
if [ "$1" == "volumes" ]; then
    df -h | egrep Filesystem\|^$storage_pool\|^$backup0_pool\|^$backup1_pool && echo && zpool list $storage_pool $backup0_pool $backup1_pool && echo && zpool status $storage_pool $backup0_pool $backup1_pool
fi
